<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github-dark.min.css"/><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/35cab027331baf7e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/35cab027331baf7e.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-83cebdb887f48834.js" defer=""></script><script src="/_next/static/chunks/pages/_app-3ca76a984b940bc2.js" defer=""></script><script src="/_next/static/chunks/465-4fe278bcc6195523.js" defer=""></script><script src="/_next/static/chunks/671-33206bff58acfdee.js" defer=""></script><script src="/_next/static/chunks/803-0cdd1b04f7cffd56.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-5dbf5693ff24e0c2.js" defer=""></script><script src="/_next/static/f-ngiEp1LmCiB9YjPT9kS/_buildManifest.js" defer=""></script><script src="/_next/static/f-ngiEp1LmCiB9YjPT9kS/_ssgManifest.js" defer=""></script><style id="__jsx-4b699aa219fdc237">.blog-content.jsx-4b699aa219fdc237{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;-webkit-box-flex:100%;-webkit-flex:100%;-moz-box-flex:100%;-ms-flex:100%;flex:100%;-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-moz-box-orient:vertical;-moz-box-direction:normal;-ms-flex-direction:column;flex-direction:column;margin:1vw 25vw 1vw 25vw;width:50vw;max-width:50vw}</style></head><body><div id="__next"><header class="Header_header__iG0T4"><div class="flex items-center h-16 px-4"><h2><a class="font-bold text-2xl flex-1" href="/">PressBlog</a></h2><ul><li><a href="/about">About</a></li><li><a href="/blog/super-fast-python-cython#">GitHub Code</a></li></ul></div></header><main><div class="p-4 flex justify-center"><div class="w-11/12 md:w-7/12 prose prose-table"><article class="jsx-4b699aa219fdc237"><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><img src="super-fast-python-cython/super-fast-python-cython.jpg" alt="Super fast Python: Cython"/></p>
<h1 style="font-family:&#x27;Ubuntu&#x27;, sans-serif;font-size:calc(1rem + 1.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Super fast Python (Part-4): Cython</h1>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This is the fourth post in the series on Python performance and Optimization. The series points out the utilization of inbuilt libraries, low-level code conversions, and other Python implementations to speed-up Python. The other posts included in this series are</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>(Part-1): <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow">Why Python is slow?</a></li>
<li>(Part-2): <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-good-practices">Good practices to write fast Python code</a></li>
<li>(Part-3): <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing">Multi-processing in Python</a></li>
<li>(Part-4): Use Cython to get speed as fast as C (this post)</li>
<li>(Part-5): <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-numba">Use Numba to speed up Python Functions and Numeric calculations</a></li>
</ul>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the last post, we discussed <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">multiprocessing</strong> to optimize Python code by utilizing parallel computing with multiple CPU cores. Multi-processing is useful when we can split certain parts of code into parallel tasks and then execute them parallelly.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Imagine when we don&#x27;t have any parallelizable code and it is taking huge time in Python compared to <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">C/C++</strong>, how to optimize the code then? One thing we can do is to convert the Python code into a low-level programming language like C/C++ and <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://docs.python.org/3/extending/extending.html">embed that C/C++ code in Python</a>. Understanding and writing C/C++ code is hard for someone who is not familiar with C/C++. Fortunately, we can get the performance speed as fast as C/C++ by writing the Python code in <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.org/">Cython</a> which is a superset of Python that provides functionality to write C-Extensions for Python.</p>
<h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">How Cython can improve Speed?</h2>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In our previous discussion on <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow">Why Python is slow?</a>, we learned that the major speed issues arise in Python due to</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>interpretation of generated bytecode</li>
<li>dynamic types and their management</li>
</ul>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">With Cython, we can take care of the above problems with both compiled code instead of interpretation and static typing instead of dynamic typing.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Cython translates the Python code into C extension code and compiles the C code into an object code that can be imported directly into Python. Also, we can make some changes like adding static types that improve the execution speed drastically over dynamic typing. Cython also supports the usage of C/C++ libraries and functions that are super-fast compared to Python libraries and functions.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Install Cython</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/quickstart/install.html">Install the Cython</a> with Pip as follows</p>
<pre><code class="language-bash">pip install Cython
</code></pre>
<blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6">
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">To compile the C code into an object file, we need a C compiler. Ubuntu comes with <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">gcc</strong> by default. For other platforms like Windows, install the C compiler if not installed previously.</p>
</blockquote>
<hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/>
<h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Cython usage</h2>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">There are multiple ways to use Cython like building manually,  using in Jupyter as an extension, or importing directly like a Python module without compilation using <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">pyximport</em>.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Build a Cython module manually</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">We write the Cython code in a file with the extension <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.pyx</em> instead of the normal Python extension <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.py</em>.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The compiler translates &#x27;.pyx&#x27; Cython file into a &#x27;.c&#x27; C file and then compiles that C file to a sharable object file &#x27;.so&#x27; (or &#x27;.pyd&#x27; on Windows). We tell the compiler those build instructions and compilation options by writing a <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#basic-setup-py">setup.py</a> file.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Cython compilation</h3>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>Translate the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.pyx</em> source code to a <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.c</em> file with additional wrappers of Python extension code.</li>
<li>Compile the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.c</em> file with a C compiler to a platform-specific shared object file <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.so</em> that can be imported directly into Python.</li>
</ul>
<pre><code class="language-python:calculate_y_cython.pyx">def fx(x, a, b, c):
    d = (a + b) * c
    return a*x + b*(x**2) + c*(x**3) + d

def y(x, n, a, b, c):
    af = fx(x, a, b, c)**2
    k = abs(n//2 - x)
    bf = fx(k, a, b, c)
    return (af-bf)/(n-1 + 1e-12)

def calculate_y_cython(n):
    ys = []
    a, b, c = 2, 5, -4
    for i in range(n):
        ys.append(y(i, n, a, b, c))
    
    return ys
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The above file <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">calculate_y.pyx</em> contains Cython code that looks the same as Python without any optimizations. Now to compile the above file, write a <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">setup.py</em> file as following</p>
<pre><code class="language-python:setup.py">from distutils.core import setup
from Cython.Build import cythonize

setup(
    name=&#x27;Calculate Expression Y&#x27;,
    ext_modules=cythonize(
        &quot;calculate_y_cython.pyx&quot;, 
        compiler_directives={&quot;language_level&quot;: &quot;3&quot;},
    )
)
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the above <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">setup.py</em>, for the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">setup()</strong>, we have passed the optional name to our Cython module for <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">name</em> and the path to the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">.pyx</em> file for the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">ext_module</em> parameter.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Build the sharable object file &#x27;.so&#x27; using the following command in the terminal</p>
<pre><code class="language-bash">python setup.py build_ext --inplace
or
python setup.py build_ext --inplace --quiet
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This will generate a translated &#x27;.c&#x27; C file and a compiled &#x27;.so&#x27; file.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">We can import the above compiled <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">calculate_y_cython</em> module directly into Python runtime.</p>
<pre><code class="language-python:main.py">from time import perf_counter
from calculate_y_cython import calculate_y_cython

def fx(x, a, b, c):
    d = (a + b) * c
    return a*x + b*(x**2) + c*(x**3) + d

def y(x, n, a, b, c):
    af = fx(x, a, b, c)**2
    k = abs(n//2 - x)
    bf = fx(k, a, b, c)
    return (af-bf)/(n-1 + 1e-12)

def calculate_y_py(n):
    ys = []
    a, b, c = 2, 5, -4
    for i in range(n):
        ys.append(y(i, n, a, b, c))
    
    return ys

def main():
    n = 100000
    # Python implementation
    atime = perf_counter()
    res = calculate_y_py(n)
    print(f&#x27;Python Time: {perf_counter()-atime:.2}&#x27;)
    
    atime = perf_counter()
    res = calculate_y_cython(n)
    print(f&#x27;Cython Time: {perf_counter()-atime:.2}&#x27;)
    
if __name__==&quot;__main__&quot;:
    main()

&quot;&quot;&quot;Output:
Python Time: 0.19
Cython Time: 0.16
&quot;&quot;&quot;
</code></pre>
<blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6">
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">At the time of writing, the latest Python version is Python 3.11 which is incredibly faster (30-60% in some cases) than earlier versions. So, to understand the Cython potential, I&#x27;m running the scripts in Python 3.8.10 on my old system with 8GB Intel(R) i5-8250U 1.60GHz CPU on HP Laptop 15-da0xxx.</p>
</blockquote>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the above <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">main.py</em>, we have imported the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">calculate_y_cython</em> module at line 2. If we look at the output to check the time taken for normal Python implementation and Cython version, they are <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">0.19</strong> and <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">0.16</strong> seconds respectively. The time difference is very low and we didn&#x27;t gain much from Cython because we haven&#x27;t done any optimization steps like</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>static typing</li>
<li>limit calling Python&#x27;s libraries</li>
<li>reducing Python&#x27;s PyObject usage</li>
</ul>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Cython Annotations</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Cython provides an easy way to check where we can optimize our Cython code by using Cython annotate feature. With the following command (<em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">-a</em> denotes annotate and <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">-3</em> denotes <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">language_level</strong> which is Python3), cython generates an HTML file that we can open in the browser to check for optimizable code. Another option is to pass the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">annotate=True</strong> parameter to <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">cythonize()</em> function call in <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">ext_modules</strong> in <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">setup</em>.</p>
<pre><code class="language-bash">cython -a calculate_y_cython.pyx -3
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If we open the generated HTML file in the browser, it will look like this</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><img src="super-fast-python-cython/cython-annotations.png" alt="Cython Annotation:=:80"/></p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The more yellow lines the more interaction with the Python interpreter. Our goal should be converting as many yellow lines as to white lines that denote pure Cython code. We discuss the optimization part in a later section.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Cython as an extension in Jupyter</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Cython can be imported and used in Jupyter directly as an extension without the need for any additional build/compilation steps.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">First load the Cython extension using <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">%load_ext cython</em>, and then, for the cell that is to be Cythonized, use the magic command <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">%%cython</em> at the top of that cell as shown in the following image.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><img src="super-fast-python-cython/cython-jupyter.png" alt="Cython Jupyter:=:40"/></p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">We can show the interactive Cython annotations in Jupyter just like we have generated the HTML file above. To show annotations, pass annotate option to <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">%%cython -a</em> magic command.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Import &#x27;.pyx&#x27; using pyximport</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">While developing or debugging, for each change in the &#x27;.pyx&#x27; file, running <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">setup.py</em> is a repetitive task and cumbersome. Instead, we can dynamically import &#x27;.pyx&#x27; to Python directly using <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#pyximport">pyximport</a> without any external build and compilation. <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">pyximport</em> takes care of compiling and building in the background without calling <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">cythonize()</em> internally. So, while importing the &#x27;.pyx&#x27; file, it will take some time to be imported as a regular Python module.</p>
<pre><code class="language-python">import pyximport
pyximport.install(language_level=3)

from calculate_y_cython import calculate_y_cython
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Though it is easy to work with Cython using <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">pyximport</strong>, there are some <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#limitations">limitations with pyximport</a> and it is also not flexible as normal setup.</p>
<blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6">
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">It is not recommended to use <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">pyximport</strong> while distributing Python packages and modules.</p>
</blockquote>
<hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/>
<h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Optimize Cython</h2>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the previous section, we have seen in the Cython annotations HTML file that many areas in the code need to be optimized for more speed. There are several ways to improve speed like</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>define static types</li>
<li>use C-libraries and functions</li>
<li>utilize OpenMP for parallel computing</li>
</ul>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Define static types to variables</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Since Python is a dynamic typing language, we can define C-like data types for Python variables in Cython. To declare C variables, prefix the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cdef</strong> keyword to the variable declaration which is the same as declaring variables in C.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The syntax for variable declaration is</p>
<pre><code class="language-python">cdef type variable_name = initilization_value {optional}
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">type</strong> can be any of the acceptable C data types.</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Define function definitions</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Python functions are defined using <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">def</strong> and <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#python-functions-vs-c-functions">C functions in Cython</a> are defined with the keyword <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cdef</strong>. The difference between <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">def</strong> and <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cdef</strong> is that with the former declaration, it can be called from anywhere both local and external modules where as <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cdef</strong> functions are only module level. Also, Cython wraps the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">def</strong> function that is defined inside &#x27;.pyx&#x27; into a Python object. There is another declaration called <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cpdef</strong> which behaves as <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">def</strong> when called from outside the module and behaves as <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">cdef</strong> inside the module, so it is faster inside the same module function call.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Cython also provides support for writing function definitions just like C. We can define parameter types and return types.</p>
<pre><code class="language-python">cdef(or cpdef) type function_name(type parameter1, ...)
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If no type is specified, the parameters and return values are treated as Python objects which need Python interpretation and they are slow.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Now, make some changes to <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">calculate_y_cython.pyx</em> with static type declarations and function definitions as,</p>
<blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6">
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/external.html">Call the C functions in Cython</a> inplace of Python functions that reduces the Python interaction.</p>
</blockquote>
<pre><code class="language-python:calculate_y_cython.pyx">ctypedef long int li
ctypedef long long int lli

cdef lli fx(li x, int a, int b, int c):
    cdef int d = (a + b) * c
    return a*x + b*(x**2) + c*(x**3) + d

cdef double y(li x, li n, int a, int b, int c):
    cdef:
        lli af = fx(x, a, b, c)**2
        li k = abs(n//2 - x)
        lli bf = fx(k, a, b, c)
    return (af-bf)/(n-1 + 1e-12)

cpdef calculate_y_cython(li n):
    ys = []
    cdef:
        int a = 2, b = 5, c = -4
        li i = 0
    for i in range(n):
        ys.append(y(i, n, a, b, c))
    
    return ys
</code></pre>
<blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6">
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">speed can be improved further by disabling bound checking(@cython.boundscheck(False)) and negative indexing(@cython.wraparound(False)) <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#compiler-directives">compiler directive instructions</a>.</p>
</blockquote>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Check the annotations for the Cython code, most of the yellow lines are now changed to white and only list operations are dark yellow because lists are Python objects. In a later section, we discuss optimizing lists using C arrays.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><img src="super-fast-python-cython/optimized_cython.jpg" alt="Optimized Cython Annotation:=:70"/></p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If we check the time for the optimized Cython code,</p>
<pre><code class="language-python">%%timeit -n 100
n = 100000
res = calculate_y_cython(n)

&quot;&quot;&quot;Output:
2.04 ms ± 166 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
&quot;&quot;&quot;
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">it takes <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">0.002</strong> seconds which is approximately <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">100x</strong> times faster than the normal Python version that takes <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">0.19</strong> seconds. By adding only static type and some tweaks, we made Python 100x faster. The powers of Cython are not limited to only static typing. We can further speed up the code with Numpy.</p>
<hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/>
<h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">1000x times faster with MemoryView and Numpy</h2>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the Cython annotation snippet above, we see that the list operations of <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">ys</strong> are still yellow as <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">list()</em> is a python object and Cython cannot optimize Python objects interaction.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">To solve this, we can convert the list type to <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/array.html">memoryview arrays</a>, and operations like <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">append()</em> to indexing just like looping in C.</p>
<pre><code class="language-python:calculate_y_cython.pyx">cimport cython
import numpy as np
cimport numpy as np

ctypedef long int li
ctypedef long long int lli

@cython.boundscheck(False)  # Deactivate bounds checking
@cython.wraparound(False)   # Deactivate negative indexing
cdef lli fx(li x, int a, int b, int c):
    cdef int d = (a + b) * c
    return a*x + b*(x**2) + c*(x**3) + d

@cython.boundscheck(False)
@cython.wraparound(False)
cdef double y(li x, li n, int a, int b, int c):
    cdef:
        lli af = fx(x, a, b, c)**2
        li k = abs(n//2 - x)
        lli bf = fx(k, a, b, c)
    return (af-bf)/(n-1 + 1e-12)

@cython.boundscheck(False)
@cython.wraparound(False)
cpdef calculate_y_cython(li n):
    cdef double[:] ys = np.empty(n, dtype=np.float64)
    cdef:
        int a = 2, b = 5, c = -4
        li i = 0
    for i in range(n):
        ys[i] = y(i, n, a, b, c)
    return ys
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Before building the object code, we need to change <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/numpy.html">build instructions to link Numpy</a> as a dependency like following</p>
<pre><code class="language-python:setup.py">from distutils.core import setup
from distutils.extension import Extension
from Cython.Build import cythonize
import numpy

ext_modules = [
    Extension(&quot;calculate_y_function&quot;,
              sources=[&quot;calculate_y_cython.pyx&quot;],
              libraries=[&quot;m&quot;],
              compiler_directives={&quot;language_level&quot;: &quot;3&quot;},
              )
]

setup(name=&quot;calculate Y function&quot;,
      ext_modules=cythonize(ext_modules),
      include_dirs=[numpy.get_include()])
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The parameter <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">include_dirs</em> includes external libraries like Numpy here.</p>
<pre><code class="language-python">%%timeit -n 1000
n = 100000
res = calculate_y_cython(n)

&quot;&quot;&quot;Output:
208 µs ± 11.3 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
&quot;&quot;&quot;
</code></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The fully optimized version of Cython runs at <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">0.0002</strong> seconds which is approximately <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">1000x</strong> faster than the normal Python code.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The usage of Numpy and MemoryViews in Cython needs separate discussion and I will write about Classes, C-math, Numpy, MemoryViews, and OpenMP in the Advanced Cython series later.</p>
<hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Cython is a very powerful extension that we can use to speed up Python code. Sometimes it may not be possible to convert Python objects straight away like dictionaries (use C++ maps), so it&#x27;s better to use Cython for repetitive tasks like loops, general functions with simple statements (like declaration and usage only), and math operations.</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Learn more about Cython by referencing</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="http://blog.behnel.de/posts/tuning-basic-object-operations-in-cython.html">Speeding up basic object operations in Cython
</a></li>
<li><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://www.infoworld.com/article/3648539/faster-python-made-easier-with-cythons-pure-python-mode.html">Faster Python made easier with Cython’s pure Python mode</a></li>
<li><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://www.peterbaumgartner.com/blog/intro-to-just-enough-cython-to-be-useful/">An Introduction to Just Enough Cython to be Useful</a></li>
<li><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://nicolas-hug.com/blog/cython_notes">Cython notes and tips</a></li>
<li><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://github.com/cython/cython/issues/3974">(Github Issue) Improve cython interface with a more user-friendly compiling interface</a></li>
</ul></article></div></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postMetadata":{"title":"Super fast Python (Part-4): Cython","description":"Convert slow Python code to run as fast as C/C++ using Cython.","imgName":"super-fast-python-cython/super-fast-python-cython.jpg","date":"Nov 18, 2022","tags":["python-performance"],"keywords":["cython","python-performance'","python-optimize","python","fast-python","speed","python"],"id":"super-fast-python-cython"},"postContent":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    img: \"img\",\n    h1: \"h1\",\n    ul: \"ul\",\n    li: \"li\",\n    a: \"a\",\n    strong: \"strong\",\n    h2: \"h2\",\n    h3: \"h3\",\n    pre: \"pre\",\n    code: \"code\",\n    blockquote: \"blockquote\",\n    hr: \"hr\",\n    em: \"em\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/super-fast-python-cython.jpg\",\n        alt: \"Super fast Python: Cython\"\n      })\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"Super fast Python (Part-4): Cython\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This is the fourth post in the series on Python performance and Optimization. The series points out the utilization of inbuilt libraries, low-level code conversions, and other Python implementations to speed-up Python. The other posts included in this series are\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-1): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow\",\n          children: \"Why Python is slow?\"\n        })]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-2): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-good-practices\",\n          children: \"Good practices to write fast Python code\"\n        })]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-3): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing\",\n          children: \"Multi-processing in Python\"\n        })]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"(Part-4): Use Cython to get speed as fast as C (this post)\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-5): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-numba\",\n          children: \"Use Numba to speed up Python Functions and Numeric calculations\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the last post, we discussed \", _jsx(_components.strong, {\n        children: \"multiprocessing\"\n      }), \" to optimize Python code by utilizing parallel computing with multiple CPU cores. Multi-processing is useful when we can split certain parts of code into parallel tasks and then execute them parallelly.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Imagine when we don't have any parallelizable code and it is taking huge time in Python compared to \", _jsx(_components.strong, {\n        children: \"C/C++\"\n      }), \", how to optimize the code then? One thing we can do is to convert the Python code into a low-level programming language like C/C++ and \", _jsx(_components.a, {\n        href: \"https://docs.python.org/3/extending/extending.html\",\n        children: \"embed that C/C++ code in Python\"\n      }), \". Understanding and writing C/C++ code is hard for someone who is not familiar with C/C++. Fortunately, we can get the performance speed as fast as C/C++ by writing the Python code in \", _jsx(_components.a, {\n        href: \"https://cython.org/\",\n        children: \"Cython\"\n      }), \" which is a superset of Python that provides functionality to write C-Extensions for Python.\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"How Cython can improve Speed?\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In our previous discussion on \", _jsx(_components.a, {\n        href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow\",\n        children: \"Why Python is slow?\"\n      }), \", we learned that the major speed issues arise in Python due to\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"interpretation of generated bytecode\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"dynamic types and their management\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"With Cython, we can take care of the above problems with both compiled code instead of interpretation and static typing instead of dynamic typing.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython translates the Python code into C extension code and compiles the C code into an object code that can be imported directly into Python. Also, we can make some changes like adding static types that improve the execution speed drastically over dynamic typing. Cython also supports the usage of C/C++ libraries and functions that are super-fast compared to Python libraries and functions.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Install Cython\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/quickstart/install.html\",\n        children: \"Install the Cython\"\n      }), \" with Pip as follows\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"pip install Cython\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"To compile the C code into an object file, we need a C compiler. Ubuntu comes with \", _jsx(_components.strong, {\n          children: \"gcc\"\n        }), \" by default. For other platforms like Windows, install the C compiler if not installed previously.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"Cython usage\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"There are multiple ways to use Cython like building manually,  using in Jupyter as an extension, or importing directly like a Python module without compilation using \", _jsx(_components.em, {\n        children: \"pyximport\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Build a Cython module manually\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We write the Cython code in a file with the extension \", _jsx(_components.em, {\n        children: \".pyx\"\n      }), \" instead of the normal Python extension \", _jsx(_components.em, {\n        children: \".py\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The compiler translates '.pyx' Cython file into a '.c' C file and then compiles that C file to a sharable object file '.so' (or '.pyd' on Windows). We tell the compiler those build instructions and compilation options by writing a \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#basic-setup-py\",\n        children: \"setup.py\"\n      }), \" file.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython compilation\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"Translate the \", _jsx(_components.em, {\n          children: \".pyx\"\n        }), \" source code to a \", _jsx(_components.em, {\n          children: \".c\"\n        }), \" file with additional wrappers of Python extension code.\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Compile the \", _jsx(_components.em, {\n          children: \".c\"\n        }), \" file with a C compiler to a platform-specific shared object file \", _jsx(_components.em, {\n          children: \".so\"\n        }), \" that can be imported directly into Python.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:calculate_y_cython.pyx\",\n        children: \"def fx(x, a, b, c):\\n    d = (a + b) * c\\n    return a*x + b*(x**2) + c*(x**3) + d\\n\\ndef y(x, n, a, b, c):\\n    af = fx(x, a, b, c)**2\\n    k = abs(n//2 - x)\\n    bf = fx(k, a, b, c)\\n    return (af-bf)/(n-1 + 1e-12)\\n\\ndef calculate_y_cython(n):\\n    ys = []\\n    a, b, c = 2, 5, -4\\n    for i in range(n):\\n        ys.append(y(i, n, a, b, c))\\n    \\n    return ys\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The above file \", _jsx(_components.em, {\n        children: \"calculate_y.pyx\"\n      }), \" contains Cython code that looks the same as Python without any optimizations. Now to compile the above file, write a \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \" file as following\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:setup.py\",\n        children: \"from distutils.core import setup\\nfrom Cython.Build import cythonize\\n\\nsetup(\\n    name='Calculate Expression Y',\\n    ext_modules=cythonize(\\n        \\\"calculate_y_cython.pyx\\\", \\n        compiler_directives={\\\"language_level\\\": \\\"3\\\"},\\n    )\\n)\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the above \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \", for the \", _jsx(_components.strong, {\n        children: \"setup()\"\n      }), \", we have passed the optional name to our Cython module for \", _jsx(_components.em, {\n        children: \"name\"\n      }), \" and the path to the \", _jsx(_components.em, {\n        children: \".pyx\"\n      }), \" file for the \", _jsx(_components.em, {\n        children: \"ext_module\"\n      }), \" parameter.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Build the sharable object file '.so' using the following command in the terminal\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"python setup.py build_ext --inplace\\nor\\npython setup.py build_ext --inplace --quiet\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This will generate a translated '.c' C file and a compiled '.so' file.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We can import the above compiled \", _jsx(_components.em, {\n        children: \"calculate_y_cython\"\n      }), \" module directly into Python runtime.\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:main.py\",\n        children: \"from time import perf_counter\\nfrom calculate_y_cython import calculate_y_cython\\n\\ndef fx(x, a, b, c):\\n    d = (a + b) * c\\n    return a*x + b*(x**2) + c*(x**3) + d\\n\\ndef y(x, n, a, b, c):\\n    af = fx(x, a, b, c)**2\\n    k = abs(n//2 - x)\\n    bf = fx(k, a, b, c)\\n    return (af-bf)/(n-1 + 1e-12)\\n\\ndef calculate_y_py(n):\\n    ys = []\\n    a, b, c = 2, 5, -4\\n    for i in range(n):\\n        ys.append(y(i, n, a, b, c))\\n    \\n    return ys\\n\\ndef main():\\n    n = 100000\\n    # Python implementation\\n    atime = perf_counter()\\n    res = calculate_y_py(n)\\n    print(f'Python Time: {perf_counter()-atime:.2}')\\n    \\n    atime = perf_counter()\\n    res = calculate_y_cython(n)\\n    print(f'Cython Time: {perf_counter()-atime:.2}')\\n    \\nif __name__==\\\"__main__\\\":\\n    main()\\n\\n\\\"\\\"\\\"Output:\\nPython Time: 0.19\\nCython Time: 0.16\\n\\\"\\\"\\\"\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"At the time of writing, the latest Python version is Python 3.11 which is incredibly faster (30-60% in some cases) than earlier versions. So, to understand the Cython potential, I'm running the scripts in Python 3.8.10 on my old system with 8GB Intel(R) i5-8250U 1.60GHz CPU on HP Laptop 15-da0xxx.\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the above \", _jsx(_components.em, {\n        children: \"main.py\"\n      }), \", we have imported the \", _jsx(_components.em, {\n        children: \"calculate_y_cython\"\n      }), \" module at line 2. If we look at the output to check the time taken for normal Python implementation and Cython version, they are \", _jsx(_components.strong, {\n        children: \"0.19\"\n      }), \" and \", _jsx(_components.strong, {\n        children: \"0.16\"\n      }), \" seconds respectively. The time difference is very low and we didn't gain much from Cython because we haven't done any optimization steps like\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"static typing\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"limit calling Python's libraries\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"reducing Python's PyObject usage\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython Annotations\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Cython provides an easy way to check where we can optimize our Cython code by using Cython annotate feature. With the following command (\", _jsx(_components.em, {\n        children: \"-a\"\n      }), \" denotes annotate and \", _jsx(_components.em, {\n        children: \"-3\"\n      }), \" denotes \", _jsx(_components.strong, {\n        children: \"language_level\"\n      }), \" which is Python3), cython generates an HTML file that we can open in the browser to check for optimizable code. Another option is to pass the \", _jsx(_components.strong, {\n        children: \"annotate=True\"\n      }), \" parameter to \", _jsx(_components.em, {\n        children: \"cythonize()\"\n      }), \" function call in \", _jsx(_components.strong, {\n        children: \"ext_modules\"\n      }), \" in \", _jsx(_components.em, {\n        children: \"setup\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-bash\",\n        children: \"cython -a calculate_y_cython.pyx -3\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we open the generated HTML file in the browser, it will look like this\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/cython-annotations.png\",\n        alt: \"Cython Annotation:=:80\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The more yellow lines the more interaction with the Python interpreter. Our goal should be converting as many yellow lines as to white lines that denote pure Cython code. We discuss the optimization part in a later section.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython as an extension in Jupyter\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython can be imported and used in Jupyter directly as an extension without the need for any additional build/compilation steps.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"First load the Cython extension using \", _jsx(_components.em, {\n        children: \"%load_ext cython\"\n      }), \", and then, for the cell that is to be Cythonized, use the magic command \", _jsx(_components.em, {\n        children: \"%%cython\"\n      }), \" at the top of that cell as shown in the following image.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/cython-jupyter.png\",\n        alt: \"Cython Jupyter:=:40\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We can show the interactive Cython annotations in Jupyter just like we have generated the HTML file above. To show annotations, pass annotate option to \", _jsx(_components.em, {\n        children: \"%%cython -a\"\n      }), \" magic command.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Import '.pyx' using pyximport\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"While developing or debugging, for each change in the '.pyx' file, running \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \" is a repetitive task and cumbersome. Instead, we can dynamically import '.pyx' to Python directly using \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#pyximport\",\n        children: \"pyximport\"\n      }), \" without any external build and compilation. \", _jsx(_components.em, {\n        children: \"pyximport\"\n      }), \" takes care of compiling and building in the background without calling \", _jsx(_components.em, {\n        children: \"cythonize()\"\n      }), \" internally. So, while importing the '.pyx' file, it will take some time to be imported as a regular Python module.\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python\",\n        children: \"import pyximport\\npyximport.install(language_level=3)\\n\\nfrom calculate_y_cython import calculate_y_cython\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Though it is easy to work with Cython using \", _jsx(_components.strong, {\n        children: \"pyximport\"\n      }), \", there are some \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#limitations\",\n        children: \"limitations with pyximport\"\n      }), \" and it is also not flexible as normal setup.\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"It is not recommended to use \", _jsx(_components.strong, {\n          children: \"pyximport\"\n        }), \" while distributing Python packages and modules.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"Optimize Cython\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In the previous section, we have seen in the Cython annotations HTML file that many areas in the code need to be optimized for more speed. There are several ways to improve speed like\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"define static types\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"use C-libraries and functions\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"utilize OpenMP for parallel computing\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Define static types to variables\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Since Python is a dynamic typing language, we can define C-like data types for Python variables in Cython. To declare C variables, prefix the \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" keyword to the variable declaration which is the same as declaring variables in C.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The syntax for variable declaration is\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python\",\n        children: \"cdef type variable_name = initilization_value {optional}\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The \", _jsx(_components.strong, {\n        children: \"type\"\n      }), \" can be any of the acceptable C data types.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Define function definitions\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Python functions are defined using \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" and \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#python-functions-vs-c-functions\",\n        children: \"C functions in Cython\"\n      }), \" are defined with the keyword \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \". The difference between \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" and \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" is that with the former declaration, it can be called from anywhere both local and external modules where as \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" functions are only module level. Also, Cython wraps the \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" function that is defined inside '.pyx' into a Python object. There is another declaration called \", _jsx(_components.strong, {\n        children: \"cpdef\"\n      }), \" which behaves as \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" when called from outside the module and behaves as \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" inside the module, so it is faster inside the same module function call.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython also provides support for writing function definitions just like C. We can define parameter types and return types.\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python\",\n        children: \"cdef(or cpdef) type function_name(type parameter1, ...)\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If no type is specified, the parameters and return values are treated as Python objects which need Python interpretation and they are slow.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Now, make some changes to \", _jsx(_components.em, {\n        children: \"calculate_y_cython.pyx\"\n      }), \" with static type declarations and function definitions as,\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [_jsx(_components.a, {\n          href: \"https://cython.readthedocs.io/en/stable/src/tutorial/external.html\",\n          children: \"Call the C functions in Cython\"\n        }), \" inplace of Python functions that reduces the Python interaction.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:calculate_y_cython.pyx\",\n        children: \"ctypedef long int li\\nctypedef long long int lli\\n\\ncdef lli fx(li x, int a, int b, int c):\\n    cdef int d = (a + b) * c\\n    return a*x + b*(x**2) + c*(x**3) + d\\n\\ncdef double y(li x, li n, int a, int b, int c):\\n    cdef:\\n        lli af = fx(x, a, b, c)**2\\n        li k = abs(n//2 - x)\\n        lli bf = fx(k, a, b, c)\\n    return (af-bf)/(n-1 + 1e-12)\\n\\ncpdef calculate_y_cython(li n):\\n    ys = []\\n    cdef:\\n        int a = 2, b = 5, c = -4\\n        li i = 0\\n    for i in range(n):\\n        ys.append(y(i, n, a, b, c))\\n    \\n    return ys\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"speed can be improved further by disabling bound checking(@cython.boundscheck(False)) and negative indexing(@cython.wraparound(False)) \", _jsx(_components.a, {\n          href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#compiler-directives\",\n          children: \"compiler directive instructions\"\n        }), \".\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Check the annotations for the Cython code, most of the yellow lines are now changed to white and only list operations are dark yellow because lists are Python objects. In a later section, we discuss optimizing lists using C arrays.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/optimized_cython.jpg\",\n        alt: \"Optimized Cython Annotation:=:70\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we check the time for the optimized Cython code,\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python\",\n        children: \"%%timeit -n 100\\nn = 100000\\nres = calculate_y_cython(n)\\n\\n\\\"\\\"\\\"Output:\\n2.04 ms ± 166 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)\\n\\\"\\\"\\\"\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"it takes \", _jsx(_components.strong, {\n        children: \"0.002\"\n      }), \" seconds which is approximately \", _jsx(_components.strong, {\n        children: \"100x\"\n      }), \" times faster than the normal Python version that takes \", _jsx(_components.strong, {\n        children: \"0.19\"\n      }), \" seconds. By adding only static type and some tweaks, we made Python 100x faster. The powers of Cython are not limited to only static typing. We can further speed up the code with Numpy.\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"1000x times faster with MemoryView and Numpy\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the Cython annotation snippet above, we see that the list operations of \", _jsx(_components.strong, {\n        children: \"ys\"\n      }), \" are still yellow as \", _jsx(_components.em, {\n        children: \"list()\"\n      }), \" is a python object and Cython cannot optimize Python objects interaction.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"To solve this, we can convert the list type to \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/tutorial/array.html\",\n        children: \"memoryview arrays\"\n      }), \", and operations like \", _jsx(_components.em, {\n        children: \"append()\"\n      }), \" to indexing just like looping in C.\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:calculate_y_cython.pyx\",\n        children: \"cimport cython\\nimport numpy as np\\ncimport numpy as np\\n\\nctypedef long int li\\nctypedef long long int lli\\n\\n@cython.boundscheck(False)  # Deactivate bounds checking\\n@cython.wraparound(False)   # Deactivate negative indexing\\ncdef lli fx(li x, int a, int b, int c):\\n    cdef int d = (a + b) * c\\n    return a*x + b*(x**2) + c*(x**3) + d\\n\\n@cython.boundscheck(False)\\n@cython.wraparound(False)\\ncdef double y(li x, li n, int a, int b, int c):\\n    cdef:\\n        lli af = fx(x, a, b, c)**2\\n        li k = abs(n//2 - x)\\n        lli bf = fx(k, a, b, c)\\n    return (af-bf)/(n-1 + 1e-12)\\n\\n@cython.boundscheck(False)\\n@cython.wraparound(False)\\ncpdef calculate_y_cython(li n):\\n    cdef double[:] ys = np.empty(n, dtype=np.float64)\\n    cdef:\\n        int a = 2, b = 5, c = -4\\n        li i = 0\\n    for i in range(n):\\n        ys[i] = y(i, n, a, b, c)\\n    return ys\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Before building the object code, we need to change \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/tutorial/numpy.html\",\n        children: \"build instructions to link Numpy\"\n      }), \" as a dependency like following\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python:setup.py\",\n        children: \"from distutils.core import setup\\nfrom distutils.extension import Extension\\nfrom Cython.Build import cythonize\\nimport numpy\\n\\next_modules = [\\n    Extension(\\\"calculate_y_function\\\",\\n              sources=[\\\"calculate_y_cython.pyx\\\"],\\n              libraries=[\\\"m\\\"],\\n              compiler_directives={\\\"language_level\\\": \\\"3\\\"},\\n              )\\n]\\n\\nsetup(name=\\\"calculate Y function\\\",\\n      ext_modules=cythonize(ext_modules),\\n      include_dirs=[numpy.get_include()])\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The parameter \", _jsx(_components.em, {\n        children: \"include_dirs\"\n      }), \" includes external libraries like Numpy here.\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-python\",\n        children: \"%%timeit -n 1000\\nn = 100000\\nres = calculate_y_cython(n)\\n\\n\\\"\\\"\\\"Output:\\n208 µs ± 11.3 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)\\n\\\"\\\"\\\"\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The fully optimized version of Cython runs at \", _jsx(_components.strong, {\n        children: \"0.0002\"\n      }), \" seconds which is approximately \", _jsx(_components.strong, {\n        children: \"1000x\"\n      }), \" faster than the normal Python code.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The usage of Numpy and MemoryViews in Cython needs separate discussion and I will write about Classes, C-math, Numpy, MemoryViews, and OpenMP in the Advanced Cython series later.\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.p, {\n      children: \"Cython is a very powerful extension that we can use to speed up Python code. Sometimes it may not be possible to convert Python objects straight away like dictionaries (use C++ maps), so it's better to use Cython for repetitive tasks like loops, general functions with simple statements (like declaration and usage only), and math operations.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Learn more about Cython by referencing\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"http://blog.behnel.de/posts/tuning-basic-object-operations-in-cython.html\",\n          children: \"Speeding up basic object operations in Cython\\n\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://www.infoworld.com/article/3648539/faster-python-made-easier-with-cythons-pure-python-mode.html\",\n          children: \"Faster Python made easier with Cython’s pure Python mode\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://www.peterbaumgartner.com/blog/intro-to-just-enough-cython-to-be-useful/\",\n          children: \"An Introduction to Just Enough Cython to be Useful\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://nicolas-hug.com/blog/cython_notes\",\n          children: \"Cython notes and tips\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/cython/cython/issues/3974\",\n          children: \"(Github Issue) Improve cython interface with a more user-friendly compiling interface\"\n        })\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}},"id":"super-fast-python-cython"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"super-fast-python-cython"},"buildId":"f-ngiEp1LmCiB9YjPT9kS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>