<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/4c8683b68ee63581.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4c8683b68ee63581.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-48f60119be4ac274.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-83cebdb887f48834.js" defer=""></script><script src="/_next/static/chunks/pages/_app-58faad4d000e90d8.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...id%5D-de3fe8db1cd8e4ba.js" defer=""></script><script src="/_next/static/LQ_N8afeaVmFBDb_CzQcG/_buildManifest.js" defer=""></script><script src="/_next/static/LQ_N8afeaVmFBDb_CzQcG/_ssgManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex min-h-screen flex-col justify-between"><nav class="w-full flex items-center border-b justify-between px-4 py-4 backdrop-blur dark:bg-transparent fixed shadow"><div><a aria-label="üë®‚Äçüíª" href="/"><div class="flex items-center justify-between"><div class="font-title fonthidden text-xl md:text-2xl xl:text-3xl font-semibold sm:block">üë®‚Äçüíª</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="font-title p-1 text-xl md:text-xl xl:text-2xl font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog"> <!-- -->Blog<!-- --> </a><a class="font-title p-1 text-xl md:text-xl xl:text-2xl font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags"> <!-- -->Tags<!-- --> </a><a class="font-title p-1 text-xl md:text-xl xl:text-2xl font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/projects"> <!-- -->Projects<!-- --> </a><a class="font-title p-1 text-xl md:text-xl xl:text-2xl font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about2"> <!-- -->About<!-- --> </a></div><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-0 left-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><div class="flex justify-end"><button type="button" class="mr-5 mt-11 h-8 w-8 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-title tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-title tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-title tracking-widest text-gray-900 dark:text-gray-100" href="/projects">Projects</a></div><div class="px-12 py-4"><a class="text-2xl font-title tracking-widest text-gray-900 dark:text-gray-100" href="/about2">About</a></div></nav></div></div></div></nav><main class="prose dark:prose-dark mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0 py-20"><!--$--><div><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Top" type="button" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><div class="border-b border-gray-200 dark:border-gray-700 text-center"><div><h1 class="text-4xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14 break-words">Super fast Python (Part-4): Cython</h1></div><div><a class="mr-4 text-mm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/python-performance">python-performance</a></div></div><p><img src="super-fast-python-cython/super-fast-python-cython.jpg" alt="Super fast Python: Cython"/></p>
<h1>Super fast Python (Part-4): Cython</h1>
<p>This is the fourth post in the series on Python performance and Optimization. The series points out the utilization of inbuilt libraries, low-level code conversions, and other Python implementations to speed-up Python. The other posts included in this series are</p>
<ul>
<li>(Part-1): <a target="_blank" rel="noopener noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow">Why Python is slow?</a></li>
<li>(Part-2): <a target="_blank" rel="noopener noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-good-practices">Good practices to write fast Python code</a></li>
<li>(Part-3): <a target="_blank" rel="noopener noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing">Multi-processing in Python</a></li>
<li>(Part-4): Use Cython to get speed as fast as C (this post)</li>
<li>(Part-5): <a target="_blank" rel="noopener noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-numba">Use Numba to speed up Python Functions and Numeric calculations</a></li>
</ul>
<p>In the last post, we discussed <strong>multiprocessing</strong> to optimize Python code by utilizing parallel computing with multiple CPU cores. Multi-processing is useful when we can split certain parts of code into parallel tasks and then execute them parallelly.</p>
<p>Imagine when we don&#x27;t have any parallelizable code and it is taking huge time in Python compared to <strong>C/C++</strong>, how to optimize the code then? One thing we can do is to convert the Python code into a low-level programming language like C/C++ and <a target="_blank" rel="noopener noreferrer" href="https://docs.python.org/3/extending/extending.html">embed that C/C++ code in Python</a>. Understanding and writing C/C++ code is hard for someone who is not familiar with C/C++. Fortunately, we can get the performance speed as fast as C/C++ by writing the Python code in <a target="_blank" rel="noopener noreferrer" href="https://cython.org/">Cython</a> which is a superset of Python that provides functionality to write C-Extensions for Python.</p>
<h2>How Cython can improve Speed?</h2>
<p>In our previous discussion on <a target="_blank" rel="noopener noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow">Why Python is slow?</a>, we learned that the major speed issues arise in Python due to</p>
<ul>
<li>interpretation of generated bytecode</li>
<li>dynamic types and their management</li>
</ul>
<p>With Cython, we can take care of the above problems with both compiled code instead of interpretation and static typing instead of dynamic typing.</p>
<p>Cython translates the Python code into C extension code and compiles the C code into an object code that can be imported directly into Python. Also, we can make some changes like adding static types that improve the execution speed drastically over dynamic typing. Cython also supports the usage of C/C++ libraries and functions that are super-fast compared to Python libraries and functions.</p>
<h3>Install Cython</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/quickstart/install.html">Install the Cython</a> with Pip as follows</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="bash" data-theme="default"><span class="line"><span style="color:#ABB2BF">pip </span><span style="color:#98C379">install</span><span style="color:#ABB2BF"> </span><span style="color:#98C379">Cython</span></span></code></pre></div></div>
<blockquote>
<p>To compile the C code into an object file, we need a C compiler. Ubuntu comes with <strong>gcc</strong> by default. For other platforms like Windows, install the C compiler if not installed previously.</p>
</blockquote>
<hr/>
<h2>Cython usage</h2>
<p>There are multiple ways to use Cython like building manually,  using in Jupyter as an extension, or importing directly like a Python module without compilation using <em>pyximport</em>.</p>
<h3>Build a Cython module manually</h3>
<p>We write the Cython code in a file with the extension <em>.pyx</em> instead of the normal Python extension <em>.py</em>.</p>
<p>The compiler translates &#x27;.pyx&#x27; Cython file into a &#x27;.c&#x27; C file and then compiles that C file to a sharable object file &#x27;.so&#x27; (or &#x27;.pyd&#x27; on Windows). We tell the compiler those build instructions and compilation options by writing a <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#basic-setup-py">setup.py</a> file.</p>
<h3>Cython compilation</h3>
<ul>
<li>Translate the <em>.pyx</em> source code to a <em>.c</em> file with additional wrappers of Python extension code.</li>
<li>Compile the <em>.c</em> file with a C compiler to a platform-specific shared object file <em>.so</em> that can be imported directly into Python.</li>
</ul>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:calculate_y_cython.pyx" data-theme="default"><span class="line"><span style="color:#abb2bf">def fx(x, a, b, c):</span></span>
<span class="line"><span style="color:#abb2bf">    d = (a + b) * c</span></span>
<span class="line"><span style="color:#abb2bf">    return a*x + b*(x**2) + c*(x**3) + d</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def y(x, n, a, b, c):</span></span>
<span class="line"><span style="color:#abb2bf">    af = fx(x, a, b, c)**2</span></span>
<span class="line"><span style="color:#abb2bf">    k = abs(n//2 - x)</span></span>
<span class="line"><span style="color:#abb2bf">    bf = fx(k, a, b, c)</span></span>
<span class="line"><span style="color:#abb2bf">    return (af-bf)/(n-1 + 1e-12)</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def calculate_y_cython(n):</span></span>
<span class="line"><span style="color:#abb2bf">    ys = []</span></span>
<span class="line"><span style="color:#abb2bf">    a, b, c = 2, 5, -4</span></span>
<span class="line"><span style="color:#abb2bf">    for i in range(n):</span></span>
<span class="line"><span style="color:#abb2bf">        ys.append(y(i, n, a, b, c))</span></span>
<span class="line"><span style="color:#abb2bf">    </span></span>
<span class="line"><span style="color:#abb2bf">    return ys</span></span></code></pre></div></div>
<p>The above file <em>calculate_y.pyx</em> contains Cython code that looks the same as Python without any optimizations. Now to compile the above file, write a <em>setup.py</em> file as following</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:setup.py" data-theme="default"><span class="line"><span style="color:#abb2bf">from distutils.core import setup</span></span>
<span class="line"><span style="color:#abb2bf">from Cython.Build import cythonize</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">setup(</span></span>
<span class="line"><span style="color:#abb2bf">    name=&#x27;Calculate Expression Y&#x27;,</span></span>
<span class="line"><span style="color:#abb2bf">    ext_modules=cythonize(</span></span>
<span class="line"><span style="color:#abb2bf">        &quot;calculate_y_cython.pyx&quot;, </span></span>
<span class="line"><span style="color:#abb2bf">        compiler_directives={&quot;language_level&quot;: &quot;3&quot;},</span></span>
<span class="line"><span style="color:#abb2bf">    )</span></span>
<span class="line"><span style="color:#abb2bf">)</span></span></code></pre></div></div>
<p>In the above <em>setup.py</em>, for the <strong>setup()</strong>, we have passed the optional name to our Cython module for <em>name</em> and the path to the <em>.pyx</em> file for the <em>ext_module</em> parameter.</p>
<p>Build the sharable object file &#x27;.so&#x27; using the following command in the terminal</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="bash" data-theme="default"><span class="line"><span style="color:#ABB2BF">python </span><span style="color:#98C379">setup.py</span><span style="color:#ABB2BF"> </span><span style="color:#98C379">build_ext</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">--inplace</span></span>
<span class="line"><span style="color:#ABB2BF">or</span></span>
<span class="line"><span style="color:#ABB2BF">python </span><span style="color:#98C379">setup.py</span><span style="color:#ABB2BF"> </span><span style="color:#98C379">build_ext</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">--inplace</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">--quiet</span></span></code></pre></div></div>
<p>This will generate a translated &#x27;.c&#x27; C file and a compiled &#x27;.so&#x27; file.</p>
<p>We can import the above compiled <em>calculate_y_cython</em> module directly into Python runtime.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:main.py" data-theme="default"><span class="line"><span style="color:#abb2bf">from time import perf_counter</span></span>
<span class="line"><span style="color:#abb2bf">from calculate_y_cython import calculate_y_cython</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def fx(x, a, b, c):</span></span>
<span class="line"><span style="color:#abb2bf">    d = (a + b) * c</span></span>
<span class="line"><span style="color:#abb2bf">    return a*x + b*(x**2) + c*(x**3) + d</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def y(x, n, a, b, c):</span></span>
<span class="line"><span style="color:#abb2bf">    af = fx(x, a, b, c)**2</span></span>
<span class="line"><span style="color:#abb2bf">    k = abs(n//2 - x)</span></span>
<span class="line"><span style="color:#abb2bf">    bf = fx(k, a, b, c)</span></span>
<span class="line"><span style="color:#abb2bf">    return (af-bf)/(n-1 + 1e-12)</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def calculate_y_py(n):</span></span>
<span class="line"><span style="color:#abb2bf">    ys = []</span></span>
<span class="line"><span style="color:#abb2bf">    a, b, c = 2, 5, -4</span></span>
<span class="line"><span style="color:#abb2bf">    for i in range(n):</span></span>
<span class="line"><span style="color:#abb2bf">        ys.append(y(i, n, a, b, c))</span></span>
<span class="line"><span style="color:#abb2bf">    </span></span>
<span class="line"><span style="color:#abb2bf">    return ys</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">def main():</span></span>
<span class="line"><span style="color:#abb2bf">    n = 100000</span></span>
<span class="line"><span style="color:#abb2bf">    # Python implementation</span></span>
<span class="line"><span style="color:#abb2bf">    atime = perf_counter()</span></span>
<span class="line"><span style="color:#abb2bf">    res = calculate_y_py(n)</span></span>
<span class="line"><span style="color:#abb2bf">    print(f&#x27;Python Time: {perf_counter()-atime:.2}&#x27;)</span></span>
<span class="line"><span style="color:#abb2bf">    </span></span>
<span class="line"><span style="color:#abb2bf">    atime = perf_counter()</span></span>
<span class="line"><span style="color:#abb2bf">    res = calculate_y_cython(n)</span></span>
<span class="line"><span style="color:#abb2bf">    print(f&#x27;Cython Time: {perf_counter()-atime:.2}&#x27;)</span></span>
<span class="line"><span style="color:#abb2bf">    </span></span>
<span class="line"><span style="color:#abb2bf">if __name__==&quot;__main__&quot;:</span></span>
<span class="line"><span style="color:#abb2bf">    main()</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">&quot;&quot;&quot;Output:</span></span>
<span class="line"><span style="color:#abb2bf">Python Time: 0.19</span></span>
<span class="line"><span style="color:#abb2bf">Cython Time: 0.16</span></span>
<span class="line"><span style="color:#abb2bf">&quot;&quot;&quot;</span></span></code></pre></div></div>
<blockquote>
<p>At the time of writing, the latest Python version is Python 3.11 which is incredibly faster (30-60% in some cases) than earlier versions. So, to understand the Cython potential, I&#x27;m running the scripts in Python 3.8.10 on my old system with 8GB Intel(R) i5-8250U 1.60GHz CPU on HP Laptop 15-da0xxx.</p>
</blockquote>
<p>In the above <em>main.py</em>, we have imported the <em>calculate_y_cython</em> module at line 2. If we look at the output to check the time taken for normal Python implementation and Cython version, they are <strong>0.19</strong> and <strong>0.16</strong> seconds respectively. The time difference is very low and we didn&#x27;t gain much from Cython because we haven&#x27;t done any optimization steps like</p>
<ul>
<li>static typing</li>
<li>limit calling Python&#x27;s libraries</li>
<li>reducing Python&#x27;s PyObject usage</li>
</ul>
<h3>Cython Annotations</h3>
<p>Cython provides an easy way to check where we can optimize our Cython code by using Cython annotate feature. With the following command (<em>-a</em> denotes annotate and <em>-3</em> denotes <strong>language_level</strong> which is Python3), cython generates an HTML file that we can open in the browser to check for optimizable code. Another option is to pass the <strong>annotate=True</strong> parameter to <em>cythonize()</em> function call in <strong>ext_modules</strong> in <em>setup</em>.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="bash" data-theme="default"><span class="line"><span style="color:#ABB2BF">cython </span><span style="color:#D19A66">-a</span><span style="color:#ABB2BF"> </span><span style="color:#98C379">calculate_y_cython.pyx</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">-3</span></span></code></pre></div></div>
<p>If we open the generated HTML file in the browser, it will look like this</p>
<p><img src="super-fast-python-cython/cython-annotations.png" alt="Cython Annotation:=:80"/></p>
<p>The more yellow lines the more interaction with the Python interpreter. Our goal should be converting as many yellow lines as to white lines that denote pure Cython code. We discuss the optimization part in a later section.</p>
<h3>Cython as an extension in Jupyter</h3>
<p>Cython can be imported and used in Jupyter directly as an extension without the need for any additional build/compilation steps.</p>
<p>First load the Cython extension using <em>%load_ext cython</em>, and then, for the cell that is to be Cythonized, use the magic command <em>%%cython</em> at the top of that cell as shown in the following image.</p>
<p><img src="super-fast-python-cython/cython-jupyter.png" alt="Cython Jupyter:=:40"/></p>
<p>We can show the interactive Cython annotations in Jupyter just like we have generated the HTML file above. To show annotations, pass annotate option to <em>%%cython -a</em> magic command.</p>
<h3>Import &#x27;.pyx&#x27; using pyximport</h3>
<p>While developing or debugging, for each change in the &#x27;.pyx&#x27; file, running <em>setup.py</em> is a repetitive task and cumbersome. Instead, we can dynamically import &#x27;.pyx&#x27; to Python directly using <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#pyximport">pyximport</a> without any external build and compilation. <em>pyximport</em> takes care of compiling and building in the background without calling <em>cythonize()</em> internally. So, while importing the &#x27;.pyx&#x27; file, it will take some time to be imported as a regular Python module.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python" data-theme="default"><span class="line"><span style="color:#C678DD;font-style:italic">import</span><span style="color:#ABB2BF"> pyximport</span></span>
<span class="line"><span style="color:#ABB2BF">pyximport.</span><span style="color:#61AFEF">install</span><span style="color:#ABB2BF">(</span><span style="color:#E06C75;font-style:italic">language_level</span><span style="color:#56B6C2">=</span><span style="color:#D19A66">3</span><span style="color:#ABB2BF">)</span></span>
<span class="line"> </span>
<span class="line"><span style="color:#C678DD;font-style:italic">from</span><span style="color:#ABB2BF"> calculate_y_cython </span><span style="color:#C678DD;font-style:italic">import</span><span style="color:#ABB2BF"> calculate_y_cython</span></span></code></pre></div></div>
<p>Though it is easy to work with Cython using <strong>pyximport</strong>, there are some <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#limitations">limitations with pyximport</a> and it is also not flexible as normal setup.</p>
<blockquote>
<p>It is not recommended to use <strong>pyximport</strong> while distributing Python packages and modules.</p>
</blockquote>
<hr/>
<h2>Optimize Cython</h2>
<p>In the previous section, we have seen in the Cython annotations HTML file that many areas in the code need to be optimized for more speed. There are several ways to improve speed like</p>
<ul>
<li>define static types</li>
<li>use C-libraries and functions</li>
<li>utilize OpenMP for parallel computing</li>
</ul>
<h3>Define static types to variables</h3>
<p>Since Python is a dynamic typing language, we can define C-like data types for Python variables in Cython. To declare C variables, prefix the <strong>cdef</strong> keyword to the variable declaration which is the same as declaring variables in C.</p>
<p>The syntax for variable declaration is</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python" data-theme="default"><span class="line"><span style="color:#ABB2BF">cdef </span><span style="color:#56B6C2">type</span><span style="color:#ABB2BF"> variable_name </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> initilization_value {optional}</span></span></code></pre></div></div>
<p>The <strong>type</strong> can be any of the acceptable C data types.</p>
<h3>Define function definitions</h3>
<p>Python functions are defined using <strong>def</strong> and <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#python-functions-vs-c-functions">C functions in Cython</a> are defined with the keyword <strong>cdef</strong>. The difference between <strong>def</strong> and <strong>cdef</strong> is that with the former declaration, it can be called from anywhere both local and external modules where as <strong>cdef</strong> functions are only module level. Also, Cython wraps the <strong>def</strong> function that is defined inside &#x27;.pyx&#x27; into a Python object. There is another declaration called <strong>cpdef</strong> which behaves as <strong>def</strong> when called from outside the module and behaves as <strong>cdef</strong> inside the module, so it is faster inside the same module function call.</p>
<p>Cython also provides support for writing function definitions just like C. We can define parameter types and return types.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python" data-theme="default"><span class="line"><span style="color:#61AFEF">cdef</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD;font-style:italic">or</span><span style="color:#ABB2BF"> cpdef) </span><span style="color:#56B6C2">type</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">function_name</span><span style="color:#ABB2BF">(</span><span style="color:#56B6C2">type</span><span style="color:#ABB2BF"> parameter1, </span><span style="color:#D19A66">...</span><span style="color:#ABB2BF">)</span></span></code></pre></div></div>
<p>If no type is specified, the parameters and return values are treated as Python objects which need Python interpretation and they are slow.</p>
<p>Now, make some changes to <em>calculate_y_cython.pyx</em> with static type declarations and function definitions as,</p>
<blockquote>
<p><a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/external.html">Call the C functions in Cython</a> inplace of Python functions that reduces the Python interaction.</p>
</blockquote>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:calculate_y_cython.pyx" data-theme="default"><span class="line"><span style="color:#abb2bf">ctypedef long int li</span></span>
<span class="line"><span style="color:#abb2bf">ctypedef long long int lli</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">cdef lli fx(li x, int a, int b, int c):</span></span>
<span class="line"><span style="color:#abb2bf">    cdef int d = (a + b) * c</span></span>
<span class="line"><span style="color:#abb2bf">    return a*x + b*(x**2) + c*(x**3) + d</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">cdef double y(li x, li n, int a, int b, int c):</span></span>
<span class="line"><span style="color:#abb2bf">    cdef:</span></span>
<span class="line"><span style="color:#abb2bf">        lli af = fx(x, a, b, c)**2</span></span>
<span class="line"><span style="color:#abb2bf">        li k = abs(n//2 - x)</span></span>
<span class="line"><span style="color:#abb2bf">        lli bf = fx(k, a, b, c)</span></span>
<span class="line"><span style="color:#abb2bf">    return (af-bf)/(n-1 + 1e-12)</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">cpdef calculate_y_cython(li n):</span></span>
<span class="line"><span style="color:#abb2bf">    ys = []</span></span>
<span class="line"><span style="color:#abb2bf">    cdef:</span></span>
<span class="line"><span style="color:#abb2bf">        int a = 2, b = 5, c = -4</span></span>
<span class="line"><span style="color:#abb2bf">        li i = 0</span></span>
<span class="line"><span style="color:#abb2bf">    for i in range(n):</span></span>
<span class="line"><span style="color:#abb2bf">        ys.append(y(i, n, a, b, c))</span></span>
<span class="line"><span style="color:#abb2bf">    </span></span>
<span class="line"><span style="color:#abb2bf">    return ys</span></span></code></pre></div></div>
<blockquote>
<p>speed can be improved further by disabling bound checking(@cython.boundscheck(False)) and negative indexing(@cython.wraparound(False)) <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#compiler-directives">compiler directive instructions</a>.</p>
</blockquote>
<p>Check the annotations for the Cython code, most of the yellow lines are now changed to white and only list operations are dark yellow because lists are Python objects. In a later section, we discuss optimizing lists using C arrays.</p>
<p><img src="super-fast-python-cython/optimized_cython.jpg" alt="Optimized Cython Annotation:=:70"/></p>
<p>If we check the time for the optimized Cython code,</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python" data-theme="default"><span class="line"><span style="color:#56B6C2">%%</span><span style="color:#ABB2BF">timeit </span><span style="color:#56B6C2">-</span><span style="color:#ABB2BF">n </span><span style="color:#D19A66">100</span></span>
<span class="line"><span style="color:#ABB2BF">n </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">100000</span></span>
<span class="line"><span style="color:#ABB2BF">res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">calculate_y_cython</span><span style="color:#ABB2BF">(n)</span></span>
<span class="line"> </span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Output:</span></span>
<span class="line"><span style="color:#98C379">2.04 ms ¬± 166 ¬µs per loop (mean ¬± std. dev. of 7 runs, 100 loops each)</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;</span></span></code></pre></div></div>
<p>it takes <strong>0.002</strong> seconds which is approximately <strong>100x</strong> times faster than the normal Python version that takes <strong>0.19</strong> seconds. By adding only static type and some tweaks, we made Python 100x faster. The powers of Cython are not limited to only static typing. We can further speed up the code with Numpy.</p>
<hr/>
<h2>1000x times faster with MemoryView and Numpy</h2>
<p>In the Cython annotation snippet above, we see that the list operations of <strong>ys</strong> are still yellow as <em>list()</em> is a python object and Cython cannot optimize Python objects interaction.</p>
<p>To solve this, we can convert the list type to <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/array.html">memoryview arrays</a>, and operations like <em>append()</em> to indexing just like looping in C.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:calculate_y_cython.pyx" data-theme="default"><span class="line"><span style="color:#abb2bf">cimport cython</span></span>
<span class="line"><span style="color:#abb2bf">import numpy as np</span></span>
<span class="line"><span style="color:#abb2bf">cimport numpy as np</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">ctypedef long int li</span></span>
<span class="line"><span style="color:#abb2bf">ctypedef long long int lli</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">@cython.boundscheck(False)  # Deactivate bounds checking</span></span>
<span class="line"><span style="color:#abb2bf">@cython.wraparound(False)   # Deactivate negative indexing</span></span>
<span class="line"><span style="color:#abb2bf">cdef lli fx(li x, int a, int b, int c):</span></span>
<span class="line"><span style="color:#abb2bf">    cdef int d = (a + b) * c</span></span>
<span class="line"><span style="color:#abb2bf">    return a*x + b*(x**2) + c*(x**3) + d</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">@cython.boundscheck(False)</span></span>
<span class="line"><span style="color:#abb2bf">@cython.wraparound(False)</span></span>
<span class="line"><span style="color:#abb2bf">cdef double y(li x, li n, int a, int b, int c):</span></span>
<span class="line"><span style="color:#abb2bf">    cdef:</span></span>
<span class="line"><span style="color:#abb2bf">        lli af = fx(x, a, b, c)**2</span></span>
<span class="line"><span style="color:#abb2bf">        li k = abs(n//2 - x)</span></span>
<span class="line"><span style="color:#abb2bf">        lli bf = fx(k, a, b, c)</span></span>
<span class="line"><span style="color:#abb2bf">    return (af-bf)/(n-1 + 1e-12)</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">@cython.boundscheck(False)</span></span>
<span class="line"><span style="color:#abb2bf">@cython.wraparound(False)</span></span>
<span class="line"><span style="color:#abb2bf">cpdef calculate_y_cython(li n):</span></span>
<span class="line"><span style="color:#abb2bf">    cdef double[:] ys = np.empty(n, dtype=np.float64)</span></span>
<span class="line"><span style="color:#abb2bf">    cdef:</span></span>
<span class="line"><span style="color:#abb2bf">        int a = 2, b = 5, c = -4</span></span>
<span class="line"><span style="color:#abb2bf">        li i = 0</span></span>
<span class="line"><span style="color:#abb2bf">    for i in range(n):</span></span>
<span class="line"><span style="color:#abb2bf">        ys[i] = y(i, n, a, b, c)</span></span>
<span class="line"><span style="color:#abb2bf">    return ys</span></span></code></pre></div></div>
<p>Before building the object code, we need to change <a target="_blank" rel="noopener noreferrer" href="https://cython.readthedocs.io/en/stable/src/tutorial/numpy.html">build instructions to link Numpy</a> as a dependency like following</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python:setup.py" data-theme="default"><span class="line"><span style="color:#abb2bf">from distutils.core import setup</span></span>
<span class="line"><span style="color:#abb2bf">from distutils.extension import Extension</span></span>
<span class="line"><span style="color:#abb2bf">from Cython.Build import cythonize</span></span>
<span class="line"><span style="color:#abb2bf">import numpy</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">ext_modules = [</span></span>
<span class="line"><span style="color:#abb2bf">    Extension(&quot;calculate_y_function&quot;,</span></span>
<span class="line"><span style="color:#abb2bf">              sources=[&quot;calculate_y_cython.pyx&quot;],</span></span>
<span class="line"><span style="color:#abb2bf">              libraries=[&quot;m&quot;],</span></span>
<span class="line"><span style="color:#abb2bf">              compiler_directives={&quot;language_level&quot;: &quot;3&quot;},</span></span>
<span class="line"><span style="color:#abb2bf">              )</span></span>
<span class="line"><span style="color:#abb2bf">]</span></span>
<span class="line"><span style="color:#abb2bf"></span></span>
<span class="line"><span style="color:#abb2bf">setup(name=&quot;calculate Y function&quot;,</span></span>
<span class="line"><span style="color:#abb2bf">      ext_modules=cythonize(ext_modules),</span></span>
<span class="line"><span style="color:#abb2bf">      include_dirs=[numpy.get_include()])</span></span></code></pre></div></div>
<p>The parameter <em>include_dirs</em> includes external libraries like Numpy here.</p>
<div data-rehype-pretty-code-fragment=""><div class="relative"><pre><code data-language="python" data-theme="default"><span class="line"><span style="color:#56B6C2">%%</span><span style="color:#ABB2BF">timeit </span><span style="color:#56B6C2">-</span><span style="color:#ABB2BF">n </span><span style="color:#D19A66">1000</span></span>
<span class="line"><span style="color:#ABB2BF">n </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> </span><span style="color:#D19A66">100000</span></span>
<span class="line"><span style="color:#ABB2BF">res </span><span style="color:#56B6C2">=</span><span style="color:#ABB2BF"> </span><span style="color:#61AFEF">calculate_y_cython</span><span style="color:#ABB2BF">(n)</span></span>
<span class="line"> </span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;Output:</span></span>
<span class="line"><span style="color:#98C379">208 ¬µs ¬± 11.3 ¬µs per loop (mean ¬± std. dev. of 7 runs, 1000 loops each)</span></span>
<span class="line"><span style="color:#98C379">&quot;&quot;&quot;</span></span></code></pre></div></div>
<p>The fully optimized version of Cython runs at <strong>0.0002</strong> seconds which is approximately <strong>1000x</strong> faster than the normal Python code.</p>
<p>The usage of Numpy and MemoryViews in Cython needs separate discussion and I will write about Classes, C-math, Numpy, MemoryViews, and OpenMP in the Advanced Cython series later.</p>
<hr/>
<p>Cython is a very powerful extension that we can use to speed up Python code. Sometimes it may not be possible to convert Python objects straight away like dictionaries (use C++ maps), so it&#x27;s better to use Cython for repetitive tasks like loops, general functions with simple statements (like declaration and usage only), and math operations.</p>
<p>Learn more about Cython by referencing</p>
<ul>
<li><a target="_blank" rel="noopener noreferrer" href="http://blog.behnel.de/posts/tuning-basic-object-operations-in-cython.html">Speeding up basic object operations in Cython
</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://www.infoworld.com/article/3648539/faster-python-made-easier-with-cythons-pure-python-mode.html">Faster Python made easier with Cython‚Äôs pure Python mode</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://www.peterbaumgartner.com/blog/intro-to-just-enough-cython-to-be-useful/">An Introduction to Just Enough Cython to be Useful</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://nicolas-hug.com/blog/cython_notes">Cython notes and tips</a></li>
<li><a target="_blank" rel="noopener noreferrer" href="https://github.com/cython/cython/issues/3974">(Github Issue) Improve cython interface with a more user-friendly compiling interface</a></li>
</ul></div><!--/$--></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"toc":[],"content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    p: \"p\",\n    img: \"img\",\n    h1: \"h1\",\n    ul: \"ul\",\n    li: \"li\",\n    a: \"a\",\n    strong: \"strong\",\n    h2: \"h2\",\n    h3: \"h3\",\n    div: \"div\",\n    pre: \"pre\",\n    code: \"code\",\n    span: \"span\",\n    blockquote: \"blockquote\",\n    hr: \"hr\",\n    em: \"em\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/super-fast-python-cython.jpg\",\n        alt: \"Super fast Python: Cython\"\n      })\n    }), \"\\n\", _jsx(_components.h1, {\n      children: \"Super fast Python (Part-4): Cython\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This is the fourth post in the series on Python performance and Optimization. The series points out the utilization of inbuilt libraries, low-level code conversions, and other Python implementations to speed-up Python. The other posts included in this series are\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-1): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow\",\n          children: \"Why Python is slow?\"\n        })]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-2): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-good-practices\",\n          children: \"Good practices to write fast Python code\"\n        })]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-3): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing\",\n          children: \"Multi-processing in Python\"\n        })]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"(Part-4): Use Cython to get speed as fast as C (this post)\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"(Part-5): \", _jsx(_components.a, {\n          href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-numba\",\n          children: \"Use Numba to speed up Python Functions and Numeric calculations\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the last post, we discussed \", _jsx(_components.strong, {\n        children: \"multiprocessing\"\n      }), \" to optimize Python code by utilizing parallel computing with multiple CPU cores. Multi-processing is useful when we can split certain parts of code into parallel tasks and then execute them parallelly.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Imagine when we don't have any parallelizable code and it is taking huge time in Python compared to \", _jsx(_components.strong, {\n        children: \"C/C++\"\n      }), \", how to optimize the code then? One thing we can do is to convert the Python code into a low-level programming language like C/C++ and \", _jsx(_components.a, {\n        href: \"https://docs.python.org/3/extending/extending.html\",\n        children: \"embed that C/C++ code in Python\"\n      }), \". Understanding and writing C/C++ code is hard for someone who is not familiar with C/C++. Fortunately, we can get the performance speed as fast as C/C++ by writing the Python code in \", _jsx(_components.a, {\n        href: \"https://cython.org/\",\n        children: \"Cython\"\n      }), \" which is a superset of Python that provides functionality to write C-Extensions for Python.\"]\n    }), \"\\n\", _jsx(_components.h2, {\n      children: \"How Cython can improve Speed?\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In our previous discussion on \", _jsx(_components.a, {\n        href: \"https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow\",\n        children: \"Why Python is slow?\"\n      }), \", we learned that the major speed issues arise in Python due to\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"interpretation of generated bytecode\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"dynamic types and their management\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"With Cython, we can take care of the above problems with both compiled code instead of interpretation and static typing instead of dynamic typing.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython translates the Python code into C extension code and compiles the C code into an object code that can be imported directly into Python. Also, we can make some changes like adding static types that improve the execution speed drastically over dynamic typing. Cython also supports the usage of C/C++ libraries and functions that are super-fast compared to Python libraries and functions.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Install Cython\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/quickstart/install.html\",\n        children: \"Install the Cython\"\n      }), \" with Pip as follows\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"bash\",\n        \"data-theme\": \"default\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"default\",\n          children: _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"pip \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"install\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Cython\"\n            })]\n          })\n        })\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"To compile the C code into an object file, we need a C compiler. Ubuntu comes with \", _jsx(_components.strong, {\n          children: \"gcc\"\n        }), \" by default. For other platforms like Windows, install the C compiler if not installed previously.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"Cython usage\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"There are multiple ways to use Cython like building manually,  using in Jupyter as an extension, or importing directly like a Python module without compilation using \", _jsx(_components.em, {\n        children: \"pyximport\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Build a Cython module manually\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We write the Cython code in a file with the extension \", _jsx(_components.em, {\n        children: \".pyx\"\n      }), \" instead of the normal Python extension \", _jsx(_components.em, {\n        children: \".py\"\n      }), \".\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The compiler translates '.pyx' Cython file into a '.c' C file and then compiles that C file to a sharable object file '.so' (or '.pyd' on Windows). We tell the compiler those build instructions and compilation options by writing a \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#basic-setup-py\",\n        children: \"setup.py\"\n      }), \" file.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython compilation\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"Translate the \", _jsx(_components.em, {\n          children: \".pyx\"\n        }), \" source code to a \", _jsx(_components.em, {\n          children: \".c\"\n        }), \" file with additional wrappers of Python extension code.\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Compile the \", _jsx(_components.em, {\n          children: \".c\"\n        }), \" file with a C compiler to a platform-specific shared object file \", _jsx(_components.em, {\n          children: \".so\"\n        }), \" that can be imported directly into Python.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:calculate_y_cython.pyx\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:calculate_y_cython.pyx\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def fx(x, a, b, c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    d = (a + b) * c\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return a*x + b*(x**2) + c*(x**3) + d\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def y(x, n, a, b, c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    af = fx(x, a, b, c)**2\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    k = abs(n//2 - x)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    bf = fx(k, a, b, c)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return (af-bf)/(n-1 + 1e-12)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def calculate_y_cython(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    ys = []\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    a, b, c = 2, 5, -4\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    for i in range(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        ys.append(y(i, n, a, b, c))\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return ys\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The above file \", _jsx(_components.em, {\n        children: \"calculate_y.pyx\"\n      }), \" contains Cython code that looks the same as Python without any optimizations. Now to compile the above file, write a \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \" file as following\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:setup.py\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:setup.py\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from distutils.core import setup\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from Cython.Build import cythonize\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"setup(\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    name='Calculate Expression Y',\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    ext_modules=cythonize(\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        \\\"calculate_y_cython.pyx\\\", \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        compiler_directives={\\\"language_level\\\": \\\"3\\\"},\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    )\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the above \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \", for the \", _jsx(_components.strong, {\n        children: \"setup()\"\n      }), \", we have passed the optional name to our Cython module for \", _jsx(_components.em, {\n        children: \"name\"\n      }), \" and the path to the \", _jsx(_components.em, {\n        children: \".pyx\"\n      }), \" file for the \", _jsx(_components.em, {\n        children: \"ext_module\"\n      }), \" parameter.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Build the sharable object file '.so' using the following command in the terminal\"\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"bash\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"default\",\n          children: [_jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"python \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"setup.py\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"build_ext\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"--inplace\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"or\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"python \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"setup.py\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"build_ext\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"--inplace\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"--quiet\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"This will generate a translated '.c' C file and a compiled '.so' file.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We can import the above compiled \", _jsx(_components.em, {\n        children: \"calculate_y_cython\"\n      }), \" module directly into Python runtime.\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:main.py\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:main.py\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from time import perf_counter\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from calculate_y_cython import calculate_y_cython\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def fx(x, a, b, c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    d = (a + b) * c\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return a*x + b*(x**2) + c*(x**3) + d\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def y(x, n, a, b, c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    af = fx(x, a, b, c)**2\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    k = abs(n//2 - x)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    bf = fx(k, a, b, c)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return (af-bf)/(n-1 + 1e-12)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def calculate_y_py(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    ys = []\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    a, b, c = 2, 5, -4\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    for i in range(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        ys.append(y(i, n, a, b, c))\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return ys\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"def main():\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    n = 100000\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    # Python implementation\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    atime = perf_counter()\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    res = calculate_y_py(n)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    print(f'Python Time: {perf_counter()-atime:.2}')\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    atime = perf_counter()\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    res = calculate_y_cython(n)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    print(f'Cython Time: {perf_counter()-atime:.2}')\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"if __name__==\\\"__main__\\\":\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    main()\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"\\\"\\\"\\\"Output:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"Python Time: 0.19\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"Cython Time: 0.16\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"\\\"\\\"\\\"\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"At the time of writing, the latest Python version is Python 3.11 which is incredibly faster (30-60% in some cases) than earlier versions. So, to understand the Cython potential, I'm running the scripts in Python 3.8.10 on my old system with 8GB Intel(R) i5-8250U 1.60GHz CPU on HP Laptop 15-da0xxx.\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the above \", _jsx(_components.em, {\n        children: \"main.py\"\n      }), \", we have imported the \", _jsx(_components.em, {\n        children: \"calculate_y_cython\"\n      }), \" module at line 2. If we look at the output to check the time taken for normal Python implementation and Cython version, they are \", _jsx(_components.strong, {\n        children: \"0.19\"\n      }), \" and \", _jsx(_components.strong, {\n        children: \"0.16\"\n      }), \" seconds respectively. The time difference is very low and we didn't gain much from Cython because we haven't done any optimization steps like\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"static typing\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"limit calling Python's libraries\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"reducing Python's PyObject usage\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython Annotations\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Cython provides an easy way to check where we can optimize our Cython code by using Cython annotate feature. With the following command (\", _jsx(_components.em, {\n        children: \"-a\"\n      }), \" denotes annotate and \", _jsx(_components.em, {\n        children: \"-3\"\n      }), \" denotes \", _jsx(_components.strong, {\n        children: \"language_level\"\n      }), \" which is Python3), cython generates an HTML file that we can open in the browser to check for optimizable code. Another option is to pass the \", _jsx(_components.strong, {\n        children: \"annotate=True\"\n      }), \" parameter to \", _jsx(_components.em, {\n        children: \"cythonize()\"\n      }), \" function call in \", _jsx(_components.strong, {\n        children: \"ext_modules\"\n      }), \" in \", _jsx(_components.em, {\n        children: \"setup\"\n      }), \".\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"bash\",\n        \"data-theme\": \"default\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"default\",\n          children: _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"cython \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"-a\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"calculate_y_cython.pyx\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"-3\"\n            })]\n          })\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we open the generated HTML file in the browser, it will look like this\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/cython-annotations.png\",\n        alt: \"Cython Annotation:=:80\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The more yellow lines the more interaction with the Python interpreter. Our goal should be converting as many yellow lines as to white lines that denote pure Cython code. We discuss the optimization part in a later section.\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Cython as an extension in Jupyter\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython can be imported and used in Jupyter directly as an extension without the need for any additional build/compilation steps.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"First load the Cython extension using \", _jsx(_components.em, {\n        children: \"%load_ext cython\"\n      }), \", and then, for the cell that is to be Cythonized, use the magic command \", _jsx(_components.em, {\n        children: \"%%cython\"\n      }), \" at the top of that cell as shown in the following image.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/cython-jupyter.png\",\n        alt: \"Cython Jupyter:=:40\"\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"We can show the interactive Cython annotations in Jupyter just like we have generated the HTML file above. To show annotations, pass annotate option to \", _jsx(_components.em, {\n        children: \"%%cython -a\"\n      }), \" magic command.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Import '.pyx' using pyximport\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"While developing or debugging, for each change in the '.pyx' file, running \", _jsx(_components.em, {\n        children: \"setup.py\"\n      }), \" is a repetitive task and cumbersome. Instead, we can dynamically import '.pyx' to Python directly using \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#pyximport\",\n        children: \"pyximport\"\n      }), \" without any external build and compilation. \", _jsx(_components.em, {\n        children: \"pyximport\"\n      }), \" takes care of compiling and building in the background without calling \", _jsx(_components.em, {\n        children: \"cythonize()\"\n      }), \" internally. So, while importing the '.pyx' file, it will take some time to be imported as a regular Python module.\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"default\",\n          children: [_jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C678DD\",\n                fontStyle: \"italic\"\n              },\n              children: \"import\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" pyximport\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"pyximport.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"install\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\",\n                fontStyle: \"italic\"\n              },\n              children: \"language_level\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C678DD\",\n                fontStyle: \"italic\"\n              },\n              children: \"from\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" calculate_y_cython \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C678DD\",\n                fontStyle: \"italic\"\n              },\n              children: \"import\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" calculate_y_cython\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Though it is easy to work with Cython using \", _jsx(_components.strong, {\n        children: \"pyximport\"\n      }), \", there are some \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#limitations\",\n        children: \"limitations with pyximport\"\n      }), \" and it is also not flexible as normal setup.\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"It is not recommended to use \", _jsx(_components.strong, {\n          children: \"pyximport\"\n        }), \" while distributing Python packages and modules.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"Optimize Cython\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"In the previous section, we have seen in the Cython annotations HTML file that many areas in the code need to be optimized for more speed. There are several ways to improve speed like\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"define static types\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"use C-libraries and functions\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"utilize OpenMP for parallel computing\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Define static types to variables\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Since Python is a dynamic typing language, we can define C-like data types for Python variables in Cython. To declare C variables, prefix the \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" keyword to the variable declaration which is the same as declaring variables in C.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The syntax for variable declaration is\"\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python\",\n        \"data-theme\": \"default\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"default\",\n          children: _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"cdef \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" variable_name \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" initilization_value {optional}\"\n            })]\n          })\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The \", _jsx(_components.strong, {\n        children: \"type\"\n      }), \" can be any of the acceptable C data types.\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"Define function definitions\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Python functions are defined using \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" and \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/latest/src/userguide/language_basics.html#python-functions-vs-c-functions\",\n        children: \"C functions in Cython\"\n      }), \" are defined with the keyword \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \". The difference between \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" and \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" is that with the former declaration, it can be called from anywhere both local and external modules where as \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" functions are only module level. Also, Cython wraps the \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" function that is defined inside '.pyx' into a Python object. There is another declaration called \", _jsx(_components.strong, {\n        children: \"cpdef\"\n      }), \" which behaves as \", _jsx(_components.strong, {\n        children: \"def\"\n      }), \" when called from outside the module and behaves as \", _jsx(_components.strong, {\n        children: \"cdef\"\n      }), \" inside the module, so it is faster inside the same module function call.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Cython also provides support for writing function definitions just like C. We can define parameter types and return types.\"\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python\",\n        \"data-theme\": \"default\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"default\",\n          children: _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"cdef\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C678DD\",\n                fontStyle: \"italic\"\n              },\n              children: \"or\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" cpdef) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"function_name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" parameter1, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"...\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \")\"\n            })]\n          })\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If no type is specified, the parameters and return values are treated as Python objects which need Python interpretation and they are slow.\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Now, make some changes to \", _jsx(_components.em, {\n        children: \"calculate_y_cython.pyx\"\n      }), \" with static type declarations and function definitions as,\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [_jsx(_components.a, {\n          href: \"https://cython.readthedocs.io/en/stable/src/tutorial/external.html\",\n          children: \"Call the C functions in Cython\"\n        }), \" inplace of Python functions that reduces the Python interaction.\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:calculate_y_cython.pyx\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:calculate_y_cython.pyx\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"ctypedef long int li\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"ctypedef long long int lli\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cdef lli fx(li x, int a, int b, int c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef int d = (a + b) * c\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return a*x + b*(x**2) + c*(x**3) + d\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cdef double y(li x, li n, int a, int b, int c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        lli af = fx(x, a, b, c)**2\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        li k = abs(n//2 - x)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        lli bf = fx(k, a, b, c)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return (af-bf)/(n-1 + 1e-12)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cpdef calculate_y_cython(li n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    ys = []\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        int a = 2, b = 5, c = -4\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        li i = 0\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    for i in range(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        ys.append(y(i, n, a, b, c))\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return ys\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"speed can be improved further by disabling bound checking(@cython.boundscheck(False)) and negative indexing(@cython.wraparound(False)) \", _jsx(_components.a, {\n          href: \"https://cython.readthedocs.io/en/stable/src/userguide/source_files_and_compilation.html#compiler-directives\",\n          children: \"compiler directive instructions\"\n        }), \".\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Check the annotations for the Cython code, most of the yellow lines are now changed to white and only list operations are dark yellow because lists are Python objects. In a later section, we discuss optimizing lists using C arrays.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.img, {\n        src: \"super-fast-python-cython/optimized_cython.jpg\",\n        alt: \"Optimized Cython Annotation:=:70\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"If we check the time for the optimized Cython code,\"\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"default\",\n          children: [_jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"%%\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"timeit \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"n \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"100\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"n \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"100000\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"res \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"calculate_y_cython\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"(n)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"\\\"\\\"\\\"Output:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"2.04 ms ¬± 166 ¬µs per loop (mean ¬± std. dev. of 7 runs, 100 loops each)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"\\\"\\\"\\\"\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"it takes \", _jsx(_components.strong, {\n        children: \"0.002\"\n      }), \" seconds which is approximately \", _jsx(_components.strong, {\n        children: \"100x\"\n      }), \" times faster than the normal Python version that takes \", _jsx(_components.strong, {\n        children: \"0.19\"\n      }), \" seconds. By adding only static type and some tweaks, we made Python 100x faster. The powers of Cython are not limited to only static typing. We can further speed up the code with Numpy.\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.h2, {\n      children: \"1000x times faster with MemoryView and Numpy\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"In the Cython annotation snippet above, we see that the list operations of \", _jsx(_components.strong, {\n        children: \"ys\"\n      }), \" are still yellow as \", _jsx(_components.em, {\n        children: \"list()\"\n      }), \" is a python object and Cython cannot optimize Python objects interaction.\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"To solve this, we can convert the list type to \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/tutorial/array.html\",\n        children: \"memoryview arrays\"\n      }), \", and operations like \", _jsx(_components.em, {\n        children: \"append()\"\n      }), \" to indexing just like looping in C.\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:calculate_y_cython.pyx\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:calculate_y_cython.pyx\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cimport cython\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"import numpy as np\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cimport numpy as np\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"ctypedef long int li\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"ctypedef long long int lli\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.boundscheck(False)  # Deactivate bounds checking\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.wraparound(False)   # Deactivate negative indexing\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cdef lli fx(li x, int a, int b, int c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef int d = (a + b) * c\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return a*x + b*(x**2) + c*(x**3) + d\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.boundscheck(False)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.wraparound(False)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cdef double y(li x, li n, int a, int b, int c):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        lli af = fx(x, a, b, c)**2\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        li k = abs(n//2 - x)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        lli bf = fx(k, a, b, c)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return (af-bf)/(n-1 + 1e-12)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.boundscheck(False)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"@cython.wraparound(False)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"cpdef calculate_y_cython(li n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef double[:] ys = np.empty(n, dtype=np.float64)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    cdef:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        int a = 2, b = 5, c = -4\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        li i = 0\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    for i in range(n):\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"        ys[i] = y(i, n, a, b, c)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    return ys\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Before building the object code, we need to change \", _jsx(_components.a, {\n        href: \"https://cython.readthedocs.io/en/stable/src/tutorial/numpy.html\",\n        children: \"build instructions to link Numpy\"\n      }), \" as a dependency like following\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python:setup.py\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python:setup.py\",\n          \"data-theme\": \"default\",\n          children: [_jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from distutils.core import setup\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from distutils.extension import Extension\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"from Cython.Build import cythonize\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"import numpy\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"ext_modules = [\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"    Extension(\\\"calculate_y_function\\\",\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"              sources=[\\\"calculate_y_cython.pyx\\\"],\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"              libraries=[\\\"m\\\"],\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"              compiler_directives={\\\"language_level\\\": \\\"3\\\"},\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"              )\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"]\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              }\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"setup(name=\\\"calculate Y function\\\",\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"      ext_modules=cythonize(ext_modules),\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#abb2bf\"\n              },\n              children: \"      include_dirs=[numpy.get_include()])\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The parameter \", _jsx(_components.em, {\n        children: \"include_dirs\"\n      }), \" includes external libraries like Numpy here.\"]\n    }), \"\\n\", _jsx(_components.div, {\n      \"data-rehype-pretty-code-fragment\": \"\",\n      children: _jsx(_components.pre, {\n        \"data-language\": \"python\",\n        \"data-theme\": \"default\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"default\",\n          children: [_jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"%%\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"timeit \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"n \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"1000\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"n \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"100000\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            className: \"line\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"res \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \" \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"calculate_y_cython\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#ABB2BF\"\n              },\n              children: \"(n)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"\\\"\\\"\\\"Output:\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"208 ¬µs ¬± 11.3 ¬µs per loop (mean ¬± std. dev. of 7 runs, 1000 loops each)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            className: \"line\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"\\\"\\\"\\\"\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"The fully optimized version of Cython runs at \", _jsx(_components.strong, {\n        children: \"0.0002\"\n      }), \" seconds which is approximately \", _jsx(_components.strong, {\n        children: \"1000x\"\n      }), \" faster than the normal Python code.\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"The usage of Numpy and MemoryViews in Cython needs separate discussion and I will write about Classes, C-math, Numpy, MemoryViews, and OpenMP in the Advanced Cython series later.\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsx(_components.p, {\n      children: \"Cython is a very powerful extension that we can use to speed up Python code. Sometimes it may not be possible to convert Python objects straight away like dictionaries (use C++ maps), so it's better to use Cython for repetitive tasks like loops, general functions with simple statements (like declaration and usage only), and math operations.\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Learn more about Cython by referencing\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"http://blog.behnel.de/posts/tuning-basic-object-operations-in-cython.html\",\n          children: \"Speeding up basic object operations in Cython\\n\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://www.infoworld.com/article/3648539/faster-python-made-easier-with-cythons-pure-python-mode.html\",\n          children: \"Faster Python made easier with Cython‚Äôs pure Python mode\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://www.peterbaumgartner.com/blog/intro-to-just-enough-cython-to-be-useful/\",\n          children: \"An Introduction to Just Enough Cython to be Useful\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://nicolas-hug.com/blog/cython_notes\",\n          children: \"Cython notes and tips\"\n        })\n      }), \"\\n\", _jsx(_components.li, {\n        children: _jsx(_components.a, {\n          href: \"https://github.com/cython/cython/issues/3974\",\n          children: \"(Github Issue) Improve cython interface with a more user-friendly compiling interface\"\n        })\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{"title":"Super fast Python (Part-4): Cython","description":"Convert slow Python code to run as fast as C/C++ using Cython.","imgName":"super-fast-python-cython/super-fast-python-cython.jpg","date":"Nov 18, 2022","tags":["python-performance"],"keywords":["cython","python-performance'","python-optimize","python","fast-python","speed","python"]},"scope":{}},"metadata":{"title":"Super fast Python (Part-4): Cython","description":"Convert slow Python code to run as fast as C/C++ using Cython.","imgName":"super-fast-python-cython/super-fast-python-cython.jpg","date":"Nov 18, 2022","tags":["python-performance"],"keywords":["cython","python-performance'","python-optimize","python","fast-python","speed","python"],"slug":"test/super-fast-python-cython","fileName":"test/super-fast-python-cython.mdx"}},"__N_SSG":true},"page":"/posts/[...id]","query":{"id":["test","super-fast-python-cython"]},"buildId":"LQ_N8afeaVmFBDb_CzQcG","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>